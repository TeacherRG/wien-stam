<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mezuzot & Tefillin Pr√ºfung - Wien</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .container{background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);padding:40px;max-width:500px;width:100%;animation:slideUp .6s ease-out}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    .header{text-align:center;margin-bottom:30px}
    .header h1{color:#2d3748;font-size:28px;margin-bottom:8px;font-weight:700}
    .header p{color:#718096;font-size:16px}
    .form-group{margin-bottom:25px}
    label{display:block;margin-bottom:8px;color:#2d3748;font-weight:600;font-size:14px}
    input,select,textarea{width:100%;padding:12px 16px;border:2px solid #e2e8f0;border-radius:12px;font-size:16px;transition:.3s;background:#f7fafc}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea;background:#fff;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .checkbox-group{display:flex;flex-direction:column;gap:15px;margin-top:10px}
    .checkbox-item{display:flex;align-items:center;padding:15px 20px;border:2px solid #e2e8f0;border-radius:12px;background:#f7fafc;cursor:pointer;transition:.3s}
    .checkbox-item:hover{border-color:#667eea;background:#edf2f7;transform:translateY(-2px)}
    .checkbox-item.selected{border-color:#667eea;background:#667eea;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,.3)}
    .checkbox-item input[type="checkbox"]{width:auto;margin-right:12px;transform:scale(1.2)}
    .checkbox-item label{margin:0;cursor:pointer;font-weight:500;font-size:16px}
    .quantity-group{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px}
    .quantity-item{display:none;opacity:0;transition:all 0.3s ease-out;transform:translateY(-10px)}
    .quantity-item.show{display:block;opacity:1;transform:translateY(0)}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .quantity-item label{font-size:14px;color:#4a5568;margin-bottom:5px}
    .quantity-item input{text-align:center;font-weight:bold}
    .submit-btn{width:100%;padding:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:.3s;margin-top:20px}
    .submit-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,.4)}
    .submit-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .success-message{background:#c6f6d5;color:#22543d;padding:15px 20px;border-radius:12px;margin-top:20px;text-align:center;font-weight:500;border:2px solid #9ae6b4}
    .error-message{background:#fed7d7;color:#c53030;padding:15px 20px;border-radius:12px;margin-top:20px;text-align:center;font-weight:500;border:2px solid #fc8181}
    .loading{display:inline-block;width:20px;height:20px;border:3px solid #fff;border-radius:50%;border-top-color:transparent;animation:spin 1s ease-in-out infinite;margin-right:10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .info-box{background:#ebf8ff;border:2px solid #90cdf4;border-radius:12px;padding:20px;margin-bottom:25px;color:#2a4365}
    .info-box h3{margin-bottom:10px;color:#2c5282}
    .info-box ul{list-style-position:inside;line-height:1.6}
    .admin-panel{position:fixed;top:20px;right:20px;z-index:1000}
    .admin-btn{background:#2d3748;color:#fff;border:none;border-radius:50%;width:50px;height:50px;cursor:pointer;font-size:18px;box-shadow:0 4px 12px rgba(0,0,0,.3);transition:.3s}
    .admin-btn:hover{background:#4a5568;transform:scale(1.1)}
    .admin-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:2000;display:none;align-items:center;justify-content:center}
    .admin-content{background:#fff;border-radius:20px;padding:30px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto}
    .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:#666}
    .bookings-table{width:100%;border-collapse:collapse;margin-top:20px}
    .bookings-table th,.bookings-table td{padding:12px;text-align:left;border-bottom:1px solid #e2e8f0}
    .bookings-table th{background:#f7fafc;font-weight:600}
    .bookings-table tbody tr:hover{background:#f7fafc}
    .password-form{text-align:center;padding:20px}
    .password-input{padding:12px;border:2px solid #e2e8f0;border-radius:8px;margin:10px;font-size:16px}
    .login-btn{background:#667eea;color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:16px}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}
    .stat-card{background:#f7fafc;padding:20px;border-radius:12px;text-align:center}
    .stat-number{font-size:24px;font-weight:bold;color:#667eea}
    .stat-label{font-size:14px;color:#666;margin-top:5px}
    .offline-warning{background:#fef5e7;border:2px solid #f6ad55;color:#c05621;padding:15px;border-radius:12px;margin-bottom:20px;text-align:center;display:none}
    @media (max-width:600px){.container{padding:30px 20px;margin:10px}.quantity-group{grid-template-columns:1fr}.admin-content{width:95%;padding:20px}.bookings-table{font-size:14px}.stats{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìø Mezuzot & Tefillin Pr√ºfung</h1>
      <p>Professionelle √úberpr√ºfung in Wien</p>
    </div>

    <div class="info-box">
      <h3>‚ÑπÔ∏è Informationen zum Termin:</h3>
      <ul>
        <li><strong>Datum:</strong> 7. September 2025</li>
        <li><strong>Zeit:</strong> 10:00 - 18:00 Uhr</li>
        <li><strong>Ort:</strong> Wien, √ñsterreich</li>
        <li><strong>Dauer:</strong> ~30 Minuten pro √úberpr√ºfung</li>
      </ul>
    </div>

    <form id="bookingForm" novalidate>
      <div class="form-group">
        <label for="time">üïê W√§hlen Sie Ihre gew√ºnschte Uhrzeit *</label>
        <select id="time" name="time" required>
          <option value="">Lade verf√ºgbare Zeiten...</option>
        </select>
      </div>

      <div class="form-group">
        <label>üìã Was m√∂chten Sie √ºberpr√ºfen lassen? *</label>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="mezuzot" name="items" value="mezuzot" />
            <label for="mezuzot">üè† Mezuzot</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="tefillin" name="items" value="tefillin" />
            <label for="tefillin">üìø Tefillin</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>üî¢ Wie viele m√∂chten Sie √ºberpr√ºfen lassen?</label>
        <div class="quantity-group">
          <div class="quantity-item" id="mezuzotQuantity">
            <label for="mezuzotCount">Anzahl Mezuzot (max. 5)</label>
            <input type="number" id="mezuzotCount" name="mezuzotCount" min="1" max="5" value="1" />
          </div>
          <div class="quantity-item" id="tefillinQuantity">
            <label for="tefillinCount">Anzahl Tefillin (max. 2)</label>
            <input type="number" id="tefillinCount" name="tefillinCount" min="1" max="2" value="1" />
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="name">üë§ Ihr Name *</label>
        <input type="text" id="name" name="name" required placeholder="Vor- und Nachname" />
      </div>

      <div class="form-group">
        <label for="email">üìß E-Mail *</label>
        <input type="email" id="email" name="email" required placeholder="ihre.email@beispiel.com" />
      </div>

      <div class="form-group">
        <label for="phone">üì± Telefonnummer</label>
        <input type="tel" id="phone" name="phone" placeholder="+43 xxx xxx xxxx" />
      </div>

      <div class="form-group">
        <label for="notes">üí≠ Besondere W√ºnsche oder Anmerkungen</label>
        <textarea id="notes" name="notes" rows="3" placeholder="Teilen Sie uns mit, falls Sie besondere W√ºnsche haben..."></textarea>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn" disabled>üìù Termin vereinbaren</button>
    </form>

    <div id="message" aria-live="polite"></div>
  </div>

  <!-- Admin-Panel -->
  <div class="admin-panel">
    <button class="admin-btn" id="openAdminBtn" title="Admin-Panel">‚öôÔ∏è</button>
  </div>

  <!-- Admin Modal -->
  <div class="admin-modal" id="adminModal" aria-hidden="true">
    <div class="admin-content">
      <div class="admin-header">
        <h2>üë®‚Äçüíª Admin-Panel</h2>
        <button class="close-btn" id="closeAdminBtn" aria-label="Schlie√üen">‚úï</button>
      </div>

      <!-- Login Form -->
      <div id="passwordForm" class="password-form">
        <h3>Passwort eingeben</h3>
        <input type="password" id="adminPassword" class="password-input" placeholder="Passwort"/>
        <br/>
        <button class="login-btn" id="adminLoginBtn">Anmelden</button>
        <div id="adminMessage"></div>
      </div>

      <!-- Admin Content -->
      <div id="adminContent" style="display:none;">
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalBookings">0</div>
            <div class="stat-label">Termine gesamt</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="mezuzotTotal">0</div>
            <div class="stat-label">Mezuzot gesamt</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="tefillinTotal">0</div>
            <div class="stat-label">Tefillin gesamt</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="availableSlots">17</div>
            <div class="stat-label">Freie Termine</div>
          </div>
        </div>

        <button class="login-btn" id="refreshDataBtn" style="margin-bottom: 20px;">Daten aktualisieren</button>

        <table class="bookings-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>E-Mail</th>
              <th>Telefon</th>
              <th>Datum</th>
              <th>Zeit</th>
              <th>Pr√ºfung</th>
              <th>Anzahl</th>
              <th>Anmerkungen</th>
            </tr>
          </thead>
          <tbody id="bookingsTableBody">
            <tr><td colspan="9" style="text-align:center;color:#666;">Lade Daten...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /********************
     * CONFIG
     ********************/
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5VVZ2QxuCOcHFAimkKijDfn4c0e97uixM_2jEfW27A60pQFAnYhnXFmIH2bIrx9wV3w/exec'; // <-- –≤–∞—à URL /exec
    const ADMIN_PASSWORD = 'mezuzot2025';
    // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è (–∫–∞–∫ –≤ –∏–Ω—Ñ–æ–±–æ–∫—Å–µ): 7. September 2025
    const EVENT_DATE_YMD = '2025-09-07'; // YYYY-MM-DD

    /********************
     * STATE
     ********************/
    let bookingsData = [];
    let bookedTimes = [];
    let isAuthenticated = false;

    /********************
     * UI HELPERS
     ********************/
    function toggleCheckbox(type) {
      try {
        const checkbox = document.getElementById(type);
        if (!checkbox) {
          console.error('Checkbox not found:', type);
          return;
        }
        
        // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —á–µ–∫–±–æ–∫—Å - –æ—Å—Ç–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É —Å–¥–µ–ª–∞–µ—Ç event listener
        checkbox.checked = !checkbox.checked;
        
        // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ change –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
        const changeEvent = new Event('change', { bubbles: true });
        checkbox.dispatchEvent(changeEvent);
        
      } catch (error) {
        console.error('Error in toggleCheckbox:', error);
      }
    }

    function formatDateTime(date) {
      return new Date(date).toLocaleString('de-DE', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.innerHTML = text;
      setTimeout(() => {
        messageDiv.innerHTML = '';
        messageDiv.className = '';
      }, 15000);
    }

    function showAdminMessage(text, type) {
      const messageDiv = document.getElementById('adminMessage');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.innerHTML = text;
      setTimeout(() => {
        messageDiv.innerHTML = '';
        messageDiv.className = '';
      }, 5000);
    }

    function setSubmitLoading(loading) {
      const btn = document.getElementById('submitBtn');
      if (loading) {
        btn.dataset.prevText = btn.innerHTML;
        btn.innerHTML = '<span class="loading"></span>Wird gesendet...';
        btn.disabled = true;
      } else {
        btn.innerHTML = btn.dataset.prevText || 'üìù Termin vereinbaren';
        updateSubmitButton();
      }
    }

    function updateSubmitButton() {
      const time = document.getElementById('time').value;
      const mezuzotChecked = document.getElementById('mezuzot').checked;
      const tefillinChecked = document.getElementById('tefillin').checked;
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();

      const btn = document.getElementById('submitBtn');
      const isValid = time && (mezuzotChecked || tefillinChecked) && name && email;
      const isTimeAvailable = time && !bookedTimes.includes(time);

      btn.disabled = !isValid || !isTimeAvailable;

      if (time && !isTimeAvailable) {
        btn.innerHTML = '‚ùå Termin bereits vergeben';
        btn.disabled = true;
      } else if (!btn.innerHTML.includes('Wird gesendet')) {
        btn.innerHTML = 'üìù Termin vereinbaren';
      }
    }

    function resetForm() {
      document.getElementById('bookingForm').reset();
      document.querySelectorAll('.checkbox-item').forEach(item => item.classList.remove('selected'));
      document.querySelectorAll('.quantity-item').forEach(item => item.classList.remove('show'));
      updateSubmitButton();
    }

    /********************
     * BACKEND COMMUNICATION
     ********************/
    async function makeRequest(data) {
      try {
        console.log('Sending request:', data);
        
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const textResponse = await response.text();
        console.log('Raw response:', textResponse);
        
        let result;
        try {
          result = JSON.parse(textResponse);
        } catch (parseError) {
          console.error('Parse error:', parseError);
          throw new Error('Ung√ºltige Antwort vom Server: ' + textResponse);
        }

        if (result.status !== 'success') {
          throw new Error(result.message || 'Serverfehler');
        }

        return result;
      } catch (error) {
        console.error('Request error:', error);
        throw error;
      }
    }

    /********************
     * SLOTS MANAGEMENT
     ********************/
    function generateSlots(startStr, endStr, stepMin) {
      const slots = [];
      const [sh, sm] = startStr.split(":").map(Number);
      const [eh, em] = endStr.split(":").map(Number);
      const start = sh*60 + sm;
      const end   = eh*60 + em;
      for (let m = start; m < end; m += stepMin) {
        const hh = String(Math.floor(m/60)).padStart(2,"0");
        const mm = String(m%60).padStart(2,"0");
        slots.push(`${hh}:${mm}`);
      }
      return slots;
    }

    async function loadAndRenderTimeOptions() {
      const select = document.getElementById('time');
      select.innerHTML = '<option value="">Lade verf√ºgbare Zeiten...</option>';

      try {
        const response = await makeRequest({
          action: 'getBusy',
          date: EVENT_DATE_YMD
        });

        bookedTimes = response.busy || [];
        const allSlots = generateSlots('10:00', '18:00', 30);
        
        select.innerHTML = '<option value="">Bitte w√§hlen Sie eine Zeit</option>';

        for (const slot of allSlots) {
          const option = document.createElement('option');
          option.value = slot;
          option.disabled = bookedTimes.includes(slot);
          option.textContent = bookedTimes.includes(slot) ? `${slot} (Belegt)` : slot;
          select.appendChild(option);
        }

      } catch (error) {
        console.error('Error loading time slots:', error);
        showMessage('Fehler beim Laden der verf√ºgbaren Zeiten: ' + error.message, 'error');
        
        // Fallback: show all slots without booking info
        const allSlots = generateSlots('10:00', '18:00', 30);
        select.innerHTML = '<option value="">Bitte w√§hlen Sie eine Zeit</option>';
        for (const slot of allSlots) {
          const option = document.createElement('option');
          option.value = slot;
          option.textContent = slot;
          select.appendChild(option);
        }
      } finally {
        updateSubmitButton();
      }
    }

    /********************
     * EVENT HANDLERS
     ********************/
    document.getElementById('time').addEventListener('change', updateSubmitButton);
    document.getElementById('name').addEventListener('input', updateSubmitButton);
    document.getElementById('email').addEventListener('input', updateSubmitButton);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
    document.getElementById('mezuzot').addEventListener('change', function() {
      const checkboxItem = this.parentElement;
      const quantityDiv = document.getElementById('mezuzotQuantity');
      
      if (this.checked) {
        checkboxItem.classList.add('selected');
        quantityDiv.classList.add('show');
      } else {
        checkboxItem.classList.remove('selected');
        quantityDiv.classList.remove('show');
      }
      updateSubmitButton();
    });

    document.getElementById('tefillin').addEventListener('change', function() {
      const checkboxItem = this.parentElement;
      const quantityDiv = document.getElementById('tefillinQuantity');
      
      if (this.checked) {
        checkboxItem.classList.add('selected');
        quantityDiv.classList.add('show');
      } else {
        checkboxItem.classList.remove('selected');
        quantityDiv.classList.remove('show');
      }
      updateSubmitButton();
    });

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ label –∏ –¥–µ–ª–∞–µ–º –∏—Ö –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏
    document.querySelectorAll('.checkbox-item label').forEach(label => {
      label.addEventListener('click', function(e) {
        e.preventDefault();
        const checkbox = this.parentElement.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.click();
        }
      });
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —á–µ–∫–±–æ–∫—Å–æ–≤
    document.querySelectorAll('.checkbox-item').forEach(item => {
      item.addEventListener('click', function(e) {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ —á–µ–∫–±–æ–∫—Å—É –∏–ª–∏ –ª–µ–π–±–ª—É
        if (e.target.type === 'checkbox' || e.target.tagName === 'LABEL') {
          return;
        }
        
        const checkbox = this.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.click();
        }
      });
    });

    ['mezuzotCount', 'tefillinCount'].forEach(id => {
      const element = document.getElementById(id);
      element.addEventListener('input', (e) => {
        const max = parseInt(e.target.max);
        const min = parseInt(e.target.min);
        let value = parseInt(e.target.value);
        if (value > max) e.target.value = max;
        if (value < min) e.target.value = min;
        updateSubmitButton();
      });
    });

    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const time = document.getElementById('time').value;
      const mezuzot = document.getElementById('mezuzot').checked;
      const tefillin = document.getElementById('tefillin').checked;
      const mezuzotCount = mezuzot ? Math.max(1, Math.min(5, parseInt(document.getElementById('mezuzotCount').value || '1', 10))) : 0;
      const tefillinCount = tefillin ? Math.max(1, Math.min(2, parseInt(document.getElementById('tefillinCount').value || '1', 10))) : 0;
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const notes = document.getElementById('notes').value.trim();

      // Client-side validation
      if (!time) return showMessage('Bitte w√§hlen Sie eine Uhrzeit.', 'error');
      if (!(mezuzot || tefillin)) return showMessage('Bitte w√§hlen Sie mindestens eine Pr√ºfung.', 'error');
      if (!name) return showMessage('Bitte geben Sie Ihren Namen ein.', 'error');
      if (!email) return showMessage('Bitte geben Sie Ihre E-Mail ein.', 'error');
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return showMessage('Bitte geben Sie eine g√ºltige E-Mail ein.', 'error');
      if (bookedTimes.includes(time)) return showMessage('Dieser Termin ist bereits vergeben. Bitte w√§hlen Sie eine andere Zeit.', 'error');

      const formData = {
        bookingDate: EVENT_DATE_YMD,
        time,
        name,
        email,
        phone,
        notes,
        mezuzot,
        mezuzotCount,
        tefillin,
        tefillinCount
      };

      setSubmitLoading(true);
      try {
        const result = await makeRequest(formData);

        // Update local state
        bookedTimes.push(time);
        updateTimeSelectOptions();

        const items = [
          mezuzot ? `${mezuzotCount} Mezuzot` : null,
          tefillin ? `${tefillinCount} Tefillin` : null
        ].filter(Boolean);

        showMessage(
          `üéâ Perfekt! Ihr Termin wurde best√§tigt.<br>
           üìÖ <strong>7. September 2025 um ${time} Uhr</strong><br>
           üìã √úberpr√ºfung: ${items.join(' und ')}<br>
           üìß Best√§tigung wurde an ${email} gesendet.<br>
           üÜî Buchungs-ID: ${result.bookingId}`,
          'success'
        );

        // Reset form
        resetForm();
        
      } catch (error) {
        console.error('Booking error:', error);
        showMessage('‚ùå Fehler: ' + error.message, 'error');
      } finally {
        setSubmitLoading(false);
      }
    });

    function updateTimeSelectOptions() {
      const select = document.getElementById('time');
      Array.from(select.options).forEach(option => {
        if (option.value && bookedTimes.includes(option.value)) {
          option.disabled = true;
          if (!option.textContent.includes('(Belegt)')) {
            option.textContent = option.value + ' (Belegt)';
          }
        }
      });
      updateSubmitButton();
    }

    /********************
     * ADMIN PANEL
     ********************/
    const adminModal = document.getElementById('adminModal');

    document.getElementById('openAdminBtn').addEventListener('click', () => {
      adminModal.style.display = 'flex';
      adminModal.setAttribute('aria-hidden', 'false');
      document.getElementById('adminPassword').focus();
    });

    document.getElementById('closeAdminBtn').addEventListener('click', () => {
      adminModal.style.display = 'none';
      adminModal.setAttribute('aria-hidden', 'true');
      document.getElementById('passwordForm').style.display = 'block';
      document.getElementById('adminContent').style.display = 'none';
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminMessage').innerHTML = '';
      isAuthenticated = false;
    });

    document.getElementById('adminPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('adminLoginBtn').click();
    });

    document.getElementById('adminLoginBtn').addEventListener('click', async () => {
      const password = document.getElementById('adminPassword').value;
      if (password !== ADMIN_PASSWORD) {
        showAdminMessage('‚ùå Falsches Passwort!', 'error');
        document.getElementById('adminPassword').value = '';
        document.getElementById('adminPassword').focus();
        return;
      }

      try {
        await loadAdminData(password);
        isAuthenticated = true;
        document.getElementById('passwordForm').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
      } catch (error) {
        showAdminMessage('‚ùå Fehler beim Laden der Daten: ' + error.message, 'error');
      }
    });

    document.getElementById('refreshDataBtn').addEventListener('click', async () => {
      if (isAuthenticated) {
        try {
          await loadAdminData(ADMIN_PASSWORD);
          showAdminMessage('‚úÖ Daten erfolgreich aktualisiert!', 'success');
        } catch (error) {
          showAdminMessage('‚ùå Fehler beim Aktualisieren: ' + error.message, 'error');
        }
      }
    }); 

    adminModal.addEventListener('click', (e) => {
      if (e.target === adminModal) {
        document.getElementById('closeAdminBtn').click();
      }
    });

    async function loadAdminData(password) {
      try {
        const response = await makeRequest({
          action: 'getBookings',
          password: password
        });

        bookingsData = response.bookings || [];
        updateAdminStats();
        loadBookingsTable();
      } catch (error) {
        console.error('Error loading admin data:', error);
        throw error;
      }
    }

    function updateAdminStats() {
      const totalMezuzot = bookingsData.reduce((sum, b) => sum + (b.mezuzot ? parseInt(b.mezuzotCount) || 0 : 0), 0);
      const totalTefillin = bookingsData.reduce((sum, b) => sum + (b.tefillin ? parseInt(b.tefillinCount) || 0 : 0), 0);
      const totalSlots = 17; // 10:00-18:00 every 30 min
      const availableSlots = totalSlots - bookedTimes.length;

      document.getElementById('totalBookings').textContent = bookingsData.length;
      document.getElementById('mezuzotTotal').textContent = totalMezuzot;
      document.getElementById('tefillinTotal').textContent = totalTefillin;
      document.getElementById('availableSlots').textContent = Math.max(availableSlots, 0);
    }

    function loadBookingsTable() {
      const tbody = document.getElementById('bookingsTableBody');
      tbody.innerHTML = '';

      if (bookingsData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="9" style="text-align:center;color:#666;">Noch keine Termine</td>';
        tbody.appendChild(row);
        return;
      }

      // Sort by time
      const sorted = [...bookingsData].sort((a, b) => {
        if (a.time && b.time) {
          return a.time.localeCompare(b.time);
        }
        return 0;
      });

      for (const booking of sorted) {
        const items = [];
        const quantities = [];
        
        if (booking.mezuzot) {
          items.push('Mezuzot');
          quantities.push(`${booking.mezuzotCount || 1} M`);
        }
        if (booking.tefillin) {
          items.push('Tefillin');
          quantities.push(`${booking.tefillinCount || 1} T`);
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${booking.id || 'N/A'}</strong></td>
          <td><strong>${booking.name || 'N/A'}</strong></td>
          <td><a href="mailto:${booking.email || ''}">${booking.email || 'N/A'}</a></td>
          <td>${booking.phone || 'Nicht angegeben'}</td>
          <td>7.9.2025</td>
          <td><strong>${booking.time || 'N/A'}</strong></td>
          <td>${items.join(', ') || '‚Äî'}</td>
          <td>${quantities.join(', ') || '‚Äî'}</td>
          <td>${booking.notes || 'Keine'}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    /********************
     * INIT
     ********************/
    document.addEventListener('DOMContentLoaded', () => {
      // Load available time slots
      loadAndRenderTimeOptions();
    });

    /********************
     * ERROR HANDLING
     ********************/
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      showMessage('‚ùå Ein unerwarteter Fehler ist aufgetreten. Bitte laden Sie die Seite neu.', 'error');
    });

    // Check if SCRIPT_URL is configured
    if (SCRIPT_URL === 'PASTE_YOUR_SCRIPT_URL_HERE') {
      showMessage('‚ö†Ô∏è Konfigurationsfehler: Bitte konfigurieren Sie die SCRIPT_URL.', 'error');
    }
  </script>
</body>
</html>
